\ProvidesPackage{lb}[30/03/2021]

% Packages which I almost always find useful
\RequirePackage{amsmath}
\RequirePackage{amsfonts}
\RequirePackage{amssymb}
\RequirePackage{mathtools}
\RequirePackage{bm}
\RequirePackage{commath}
\RequirePackage{enumitem}
% For more powerful command argument parsing
\RequirePackage{xparse, xargs}
% \RequirePackage[usenames,dvipsnames]{color, xcolor}
% For more \mathbb support
\RequirePackage{bbm}
% Hyperlinks are cool
\RequirePackage{url}
\RequirePackage{hyperref}
% Units
\RequirePackage{siunitx}

%% OPTIONS %%

% Optionally include the other style files. This saves having to include each of them individually.
% \RequirePackage cannot be used in \DeclareOption, so instead we need to use boolean flags.
% This means that you only need \usepackage[...]{lb} in your preamble, with the specified extras as
% options.
\newif\if@statistics\@statisticsfalse
\DeclareOption{statistics}{\@statisticstrue}

\newif\if@notes\@notesfalse
\DeclareOption{notes}{\@notestrue}

\newif\if@linearalgebra\@linearalgebrafalse
\DeclareOption{linearalgebra}{\@linearalgebratrue}

% Option indicating whether the style file is being used in RMarkdown
% This introduces some changes to certain commands, e.g. enumerate
\newif\if@rmarkdown\@rmarkdownfalse
\DeclareOption{rmarkdown}{\@rmarkdowntrue}

\ProcessOptions\relax

% Additional package inclusions
\if@statistics
	\RequirePackage{lb_statistics}
\fi

\if@notes
	\RequirePackage{lb_notes}
\fi

\if@linearalgebra
	\RequirePackage{lb_linear_algebra}
\fi

% Provides warnings if labels are unused
\RequirePackage{refcheck}
\norefnames
\nocitenames


% Allow numbering of individuals lines in an align env
\newcommand{\numberthis}{\addtocounter{equation}{1}\tag{\theequation}}


% Numeric sets
\newcommand{\R}{\mathbb{R}}		% Real numbers
\newcommand{\Z}{\mathbb{Z}}		% Integers
\newcommand{\N}{\mathbb{N}}		% Natural numbers
\newcommand{\Q}{\mathbb{Q}}		% Rational numbers
% TODO: RMarkdown on Windows dislikes this
\newcommand{\C}{\mathbb{C}}		% Complex numbers

% Set with a condition
\newcommand{\setc}[2]{\left\{#1\,\middle|\,#2\right\}}

% Bracketed fractions
\newcommand{\bfrac}[2]{\left(\frac{#1}{#2}\right)}

% Bracketed super script.
\newcommand{\bs}{}

% Floor and ceiling
\newcommand{\floor}[1]{\left\lfloor#1\right\rfloor}
\newcommand{\ceil}[1]{\left\lceil#1\right\rceil}

% Smaller dot operator for dot product, etc.
\makeatletter
\newcommand*{\dotp}{\mathpalette\dotp@{.5}}
\newcommand*{\dotp@}[2]{\mathbin{\vcenter{\hbox{\scalebox{#2}{$\m@th#1\bullet$}}}}}
\makeatother

% Inner product, simply langle and rangle
\newcommand{\iprod}[2]{\langle #1\,,\,#2 \rangle}

% Hyperbolic functions 
\DeclareMathOperator{\sech}{sech}
\DeclareMathOperator{\csch}{csch}

% Vector calculus operators
\newcommand{\vder}{\nabla}					% Gradient
\newcommand{\vdiv}{\vder \cdot}			% Divergence
\newcommand{\curl}{\vder \times}    % Curl

\newcommand{\hessian}{\nabla\nabla}

% Vector integrals
% TODO as required

% Differential form of an SDE
% TODO: Include an optional parameter for the noise, defaulting to W_t
\newcommand{\sde}[3]{\dif #1 = #2\dif t + #3 \dif W_t}

% Material derivative, in a fluid dynamics context
\newcommand{\dmat}[2]{\frac{\text{D}#1}{\text{D}#2}}

% Matrix trace
\newcommand{\trace}[1]{\mathrm{tr}\left(#1\right)}

% A sequence of the form a_1,...,a_n, where a is passed as an argument. The second and third arguments are optional and specify the two subscript values to include.
\NewDocumentCommand{\seq}{O{1} O{n} m}{#3_{#1},\hdots,#3_{#2}}

% Provide reasoning in a \text env alongside a line of maths
\newcommand{\reason}[1]{\qquad \qquad \left(\text{#1}\right)}

% argmax and argmin
\DeclareMathOperator{\argmax}{argmax}
\DeclareMathOperator{\argmin}{argmin}

% Transpose operator with \T
\newcommand{\T}{^{\intercal}}

% Enumerate environment with alphabetic labels
\newenvironment{alpharate}{
	\begin{enumerate}[label=\alph*)]
		}{
	\end{enumerate}
}

% Enumerate environment with Roman numbers
\newenvironment{romanate}{
	\begin{enumerate}[label=(\roman*)]
		}{
	\end{enumerate}
}

% Todo notes, annotations, etc.
% Thanks JM
\RequirePackage[colorinlistoftodos,prependcaption,textsize=scriptsize]{todonotes}

% TODO: Optional args seems to not be working
\newcommandx{\note}[2][1=]{
	\todo[inline,linecolor=black,backgroundcolor=violet!5,bordercolor=violet,#1]{
		NOTE: #2
	}
}
\newcommandx{\td}[2][1=]{
	\todo[inline,linecolor=orange,backgroundcolor=orange!5,bordercolor=orange,tickmarkheight=2cm,#1]{
		TODO: #2
	}
}
\newcommandx{\lb}[2][1=]{
	\todo[linecolor=teal,backgroundcolor=teal!5,bordercolor=teal,#1]{
		#2
	}
}

% Placeholder for a citation
\newcommand{\citehere}{{\color{blue}{[citation needed]}} }

% Some commonly-used names with accents
\newcommand{\ito}{It\^{o}}
\newcommand{\gronwall}{Gr\"{o}nwall}
\newcommand{\holder}{H\"{o}lder}
\newcommand{\burkholder}{Burkh\"{o}lder}

% Neat trick to access environment variables
% From https://tex.stackexchange.com/a/62032
\ExplSyntaxOn
\NewDocumentCommand{\getenv}{om}
{
	\sys_get_shell:nnN { kpsewhich ~ --var-value ~ #2 } { } \l_tmpa_tl
	\tl_trim_spaces:N \l_tmpa_tl
	\IfNoValueTF { #1 }
	{
		\tl_use:N \l_tmpa_tl
	}
	{
		\tl_set_eq:NN #1 \l_tmpa_tl
	}
}
\ExplSyntaxOff

% Modifications for RMarkdown
\if@rmarkdown
	% Including code blocks in an enumerate environment causes knitr to fail,
	% so instead we delimit the environment with these new commands.
	% See https://tex.stackexchange.com/a/244996
	% TODO (formatting): latexindent is confused by the begin and ends here.
	\newcommand{\benum}{\begin{enumerate}}
			\newcommand{\eenum}{\end{enumerate}}
	\newcommand{\balph}{\begin{alpharate}}
			\newcommand{\ealph}{\end{alpharate}}

\fi

% This is needed to use a .bib file outside of the same directory as the TeX file via a relative 
% path, when using an output directory (e.g. /build).
% Include the bibliography as 
%		\bibliography{\mainabsdir/the/relative/path}
% From https://tex.stackexchange.com/a/383143
% BibTeX is fucking stupid and this is a stupid hack.
\RequirePackage{currfile-abspath}
\getmainfile
\getabspath{\themainfile}
\let\mainabsdir\theabsdir
\let\mainabspath\theabspath

% Mainly a temporary change for masters
% Replace \epsilon with \varepsilon. Use \oldepsilon to access the old symbol.
\newcommand{\oldepsilon}{\epsilon}
\renewcommand{\epsilon}{\varepsilon}

